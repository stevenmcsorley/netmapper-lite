#!/bin/bash
# Single command to launch NetMapper-Lite (helper + GUI)

cd "$(dirname "$0")"

echo "=========================================="
echo "NetMapper-Lite Launcher"
echo "=========================================="
echo ""

# Stop any existing helper
pkill -f netmapper_helper.py 2>/dev/null || true
sleep 1
# Remove socket (may need sudo if created by root)
sudo rm -f /tmp/netmapper-helper.sock 2>/dev/null || rm -f /tmp/netmapper-helper.sock 2>/dev/null || true

# Check if we need sudo for helper
NEED_SUDO=0
if ! getcap $(which python3) 2>/dev/null | grep -q net_raw; then
    NEED_SUDO=1
fi

if [ $NEED_SUDO -eq 1 ]; then
    echo "Starting helper with sudo (requires password)..."
    echo ""
    # Start helper with sudo in background, preserve NETMAPPER_MOCK_SCAN if set
    if [ -n "$NETMAPPER_MOCK_SCAN" ]; then
        sudo -b -E python3 backend/netmapper_helper.py --dev > /tmp/helper.log 2>&1
    else
        sudo -b python3 backend/netmapper_helper.py --dev > /tmp/helper.log 2>&1
    fi
else
    echo "Starting helper..."
    # Preserve environment variables
    NETMAPPER_DEV=true python3 backend/netmapper_helper.py --dev > /tmp/helper.log 2>&1 &
fi

# Wait for helper to start
echo "Waiting for helper to start..."
HELPER_STARTED=0
for i in {1..15}; do
    if [ -e /tmp/netmapper-helper.sock ]; then
        # Verify socket is actually working
        python3 -c "import socket; s = socket.socket(socket.AF_UNIX); s.settimeout(1); s.connect('/tmp/netmapper-helper.sock'); s.close()" 2>/dev/null && {
            echo "✅ Helper started and responding"
            HELPER_STARTED=1
            break
        }
    fi
    sleep 0.5
done

if [ $HELPER_STARTED -eq 0 ]; then
    echo "❌ Helper failed to start or is not responding"
    echo "Check logs: tail -20 /tmp/helper.log"
    tail -10 /tmp/helper.log 2>/dev/null || echo "No log file found"
    echo ""
    echo "Trying to start helper manually..."
    if [ $NEED_SUDO -eq 1 ]; then
        echo "Run: sudo python3 backend/netmapper_helper.py --dev"
    else
        echo "Run: python3 backend/netmapper_helper.py --dev"
    fi
    exit 1
fi

echo ""
echo "Starting GUI..."
echo ""

# Check DISPLAY
if [ -z "$DISPLAY" ]; then
    echo "⚠️  Warning: DISPLAY not set. Trying :0..."
    export DISPLAY=:0
fi

# Start GUI (foreground)
python3 frontend/gui.py 2>&1
GUI_EXIT=$?

if [ $GUI_EXIT -ne 0 ]; then
    echo ""
    echo "⚠️  GUI exited with error code $GUI_EXIT"
    echo "Check if DISPLAY is set: echo \$DISPLAY"
fi

# When GUI closes, cleanup
echo ""
echo "Cleaning up..."
pkill -f netmapper_helper.py 2>/dev/null || true
sleep 1
# Remove socket (may need sudo if created by root)
sudo rm -f /tmp/netmapper-helper.sock 2>/dev/null || rm -f /tmp/netmapper-helper.sock 2>/dev/null || true
echo "Done."

